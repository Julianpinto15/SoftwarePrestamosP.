<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5" lang="">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/128/1077/1077874.png" type="image/x-icon">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>


	<title>Préstamos</title>
	<style>
		:root {
			--sidebar-width: 280px;
			--sidebar-bg: #343a40;
			--text-color: #ffffff;
			--hover-bg: rgba(255, 255, 255, 0.1);
		}

		/* Estilos base */
		body {
			font-family: 'Nunito', sans-serif;
			background-color: #f8f9fc;
			margin: 0;
			padding: 0;
			min-height: 100vh;
			display: flex;
		}

		/* Contenedor principal */
		.wrapper {
			display: flex;
			flex-direction: column;
			min-height: 100vh;
		}

		/* Sidebar */
		#sidebar {
			width: var(--sidebar-width);
			min-width: var(--sidebar-width);
			background: var(--sidebar-bg);
			color: var(--text-color);
			position: fixed;
			height: 100vh;
			z-index: 1000;
			left: 0;
			top: 0;
		}

		/* Header del sidebar */
		.sidebar-header {
			display: grid;
			place-items: center;
			padding: 20px 0;
			border-bottom: 1px solid rgba(255,255,255,0.1);
		}

		.logo-text {
			font-size: 32px;
			font-weight: 600;
			text-align: center;
			gap: 0.5rem;
		}

		.logo-text i {
			font-size: 1.5rem;
		}

		/* Contenedor de navegación */
		.components {
			flex: 1;
			padding: 1rem 0;
			overflow-y: auto;
		}

		/* Elementos del menú */
		.menu-item {
			margin: 0.5rem 1rem;
		}

		.menu-item a {
			padding: 0.75rem 1rem;
			color: var(--text-color);
			display: flex;
			align-items: center;
			text-decoration: none;
			border-radius: 0.5rem;
			transition: all 0.2s ease;
			gap: 0.75rem;

		}

		.menu-item a:hover {
			background: var(--hover-bg);
			transform: translateX(5px);
		}

		.menu-item i {
			width: 20px;
			text-align: center;
			font-size: 1.1rem;
		}

		/* Botón de cerrar sesión */
		.logout-container {
			padding: 1rem;
			border-top: 1px solid rgba(255,255,255,0.1);
			margin: 0 3rem;
		}

		.btn-danger {
			background-color: #dc3545;
			border: none;
			width: 100%;
			padding: 0.75rem;
			color: white;
			border-radius: 0.5rem;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			transition: all 0.2s ease;
		}

		.btn-danger:hover {
			background-color: #c82333;
		}

		/* Contenido principal */

		.main-content {
			margin-left: var(--sidebar-width); /* Espacio para el sidebar */
			width: calc(100% - var(--sidebar-width));
			padding: 1rem 2rem 0 2rem;
			background: #f8f9fc;
			display: flex;
			flex-direction: column;
			flex-grow: 1;
		}

		/* Responsive */
		@media (max-width: 768px) {
			#sidebar {
				transform: translateX(-100%);
			}

			#sidebar.active {
				transform: translateX(0);
			}

			.main-content {
				margin-left: 0;
				width: 100%;
			}

			.stats-position{
				flex-direction: column;
				gap: 10px;
			}

			.sidebar-toggle {
				position: fixed;
				left: var(--sidebar-width);
				top: 20px;
				background-color: var(--sidebar-bg);
				color: white;
				border: none;
				border-radius: 0 8px 8px 0;
				padding: 10px 15px;
				z-index: 1;
				box-shadow: 3px 0 10px rgba(0,0,0,0.1);
				transition: all 0.3s ease;
			}

			.sidebar-toggle {
				display: block;
				left: 0;
			}

			.sidebar-toggle:hover {
				background-color: var(--sidebar-bg);
			}

			/* Cuando el sidebar está activo, el botón se mueve con él */
			#sidebar.active + .sidebar-toggle,
			#sidebar.active ~ .sidebar-toggle {
				left: var(--sidebar-width);
			}
		}

		@media (min-width: 769px) {
			.sidebar-toggle {
				display: none;
			}
		}

		/* Por defecto, para pantallas pequeñas (teléfonos, < 768px) */
		.paginator {
			padding-left: 47px;
		}

		/* Para pantallas grandes (>= 768px) */
		@media (min-width: 768px) {
			.paginator {
				padding-left: 326px;
			}
		}

		.user-info span{
			text-align: center;
		}

		.position{
			display: flex;
			justify-content: center;
			align-items: center;
			font-size: 30px;
			text-transform: capitalize;
			padding-bottom: 25px;
		}

		/*estilos para el main*/

		.loan-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
			gap: 1rem;
			padding: 1rem;
		}

		.loan-card {
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			padding: 1rem;
			cursor: pointer;
			transition: transform 0.2s;
		}

		.loan-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.15);
		}

		.loan-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 0.5rem;
		}

		.loan-status {
			padding: 0.25rem 0.75rem;
			border-radius: 999px;
			font-size: 0.875rem;
		}

		.status-ontime {
			background: #dcfce7;
			color: #166534;
		}

		.status-late {
			background: #fee2e2;
			color: #991b1b;
		}

		.loan-summary {
			margin: 0.5rem 0;
		}

		.loan-amount {
			font-size: 1.25rem;
			font-weight: 600;
			color: #1f2937;
		}

		/* Modal styles */
		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			z-index: 1000;
			overflow: hidden;
		}

		.modal-content {
			position: relative;
			background: white;
			margin: 2rem auto;
			padding: 1.5rem;
			border-radius: 8px;
			max-width: 431px;
			animation: slideIn 0.3s ease-out;
		}

		@keyframes slideIn {
			from {
				transform: translateY(-100px);
				opacity: 0;
			}
			to {
				transform: translateY(0);
				opacity: 1;
			}
		}

		.modal-close {
			position: absolute;
			top: 1rem;
			right: 1rem;
			background: none;
			border: none;
			font-size: 1.5rem;
			cursor: pointer;
			color: #6b7280;
		}

		.modal-section {
			margin-bottom: 5px;
			padding-bottom: 1rem;
			border-bottom: 1px solid #e5e7eb;
		}

		.modal-section:last-child {
			border-bottom: none;
		}

		.modal-actions {
			display: flex;
			gap: 0.5rem;
		}

		.action-button {
			padding: 0.5rem 1rem;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 0.875rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			text-decoration: none;
		}

		.btn-view { background: #dbeafe; color: #1e40af; }
		.btn-edit { background: #fef3c7; color: #92400e; }
		.btn-delete { background: #fee2e2; color: #991b1b; }

		.search-container {
			width: 100%;
			margin-bottom: 2rem;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 0 20px;
		}

		.search-wrapper {
			position: relative;
			width: 100%;
			max-width: 300px; /* Controla el ancho máximo */
		}

		.search-input {
			width: 100%;
			padding: 10px 10px 10px 40px; /* Espacio a la izquierda para el icono */
			border: 1px solid #e5e7eb;
			border-radius: 15px;
			font-size: 1rem;
			color: #374151;
			background-color: #f9fafb;
			transition: all 0.3s ease;
		}

		.search-input:focus {
			border-color: #3b82f6; /* Cambia el borde al hacer foco */
			box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
			outline: none;
		}

		.search-icon {
			position: absolute;
			left: 15px;
			top: 67%;
			transform: translateY(-50%);
			color: #6b7280;
			font-size: 1rem;
			pointer-events: none;
		}


		.stats-position{
			display: flex;
			padding-right: 5px;
			flex-wrap: wrap;
		}

		.position-div{
			padding-left: 14px;
			padding-right: 4px;
		}

		.modal-backdrop.show{
			z-index: 1;
		}

		.seccion-parrafo{
			margin: 0;
		}

		.parrafo1{
			padding-top: 10px;
		}

		.parrafo2{
			padding-top: 4px;
		}

		.info-line {
			margin: 0 0;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.info-line i {
			margin-left: 10px;
		}

		.info-line i:first-child {
			margin-left: 0;
		}

		.modal-position{
			z-index: 1000;
		}

		.loan-status {
			font-weight: bold;
		}
		.status-ontime {
			color: green;
		}
		.status-late {
			color: red;
			font-weight: bold;
		}
		.status-warning {
			color: orange;
		}

		.wrapper-position{
			display: flex;
			flex-direction: column;
			justify-content: space-between;
		}

		.caja{
			color: green;
		}

		.cajaD{
			color: #551414;
		}

		.caja-span{
			font-weight: bold;
		}

		.loan-status {
			padding: 0.25rem 0.5rem;
			border-radius: 0.25rem;
			font-weight: bold;
		}

		.status-ontime {
			background-color: #d4edda; /* Verde claro */
			color: #155724; /* Verde oscuro */
		}

		.status-ontime_active{
			background-color: #d7e2ff; /* Verde claro */
			color: #0d6efd;
		}

		.status-late {
			background-color: #f8d7da; /* Rojo claro */
			color: #721c24; /* Rojo oscuro */
		}

		.payment-amount {
			margin-top: 0.5rem;
		}

		.payment-amount span {
			display: block;
			font-size: 0.9rem;
			color: #4a5568;
		}

		/* Estilo para valores modificados */
		.payment-amount span:last-child {
			color: #2b6cb0;
			font-weight: 500;
		}

		.footer{
			display: flex;
			justify-content: space-between;
			align-items: flex-end;
		}

	</style>
</head>

<body>
<div class="wrapper">

	<!-- Agregar esto justo después del div.wrapper -->
	<div th:if="${success}" data-flash-success th:data-flash-message="${success}" style="display: none;"></div>
	<div th:if="${error}" data-flash-error th:data-flash-message="${error}" style="display: none;"></div>

	<!-- Sidebar -->
	<nav id="sidebar">

		<div class="sidebar-header">
			<div class="logo-text">
				Sistema de Préstamos
			</div>
		</div>

		<!-- Menú principal -->
		<ul class="list-unstyled components">
			<!--Información del usuario-->
			<div class="user-info">
				<div class="position">
					<i class="bi bi-person-circle me-2"></i>
					<strong><span sec:authentication="principal.username"></span></strong>
				</div>
			</div>

			<li class="menu-item" sec:authorize="hasAnyRole('ADMIN', 'COBRADOR1', 'COBRADOR2')">
				<a th:href="@{/form}">
					<i class="fas fa-plus-circle"></i>
					<span>Nuevo Préstamo</span>
				</a>
			</li>

			<li class="menu-item" sec:authorize="hasAnyRole('ADMIN')">
				<a href="#" data-bs-toggle="modal" data-bs-target="#addMoneyModal">
					<i class="fas fa-dollar-sign"></i>
					<span>Agregar Dinero</span>
				</a>
			</li>

			<li class="menu-item">
				<a th:href="@{/exportarPDF}" id="exportarPDFBtn" target="_blank">
					<i class="fas fa-file-pdf"></i>
					<span>Exportar PDF</span>
				</a>
			</li>

			<li class="menu-item">
				<a th:href="@{/exportarExcel}">
					<i class="fas fa-file-excel"></i>
					<span>Exportar Excel</span>
				</a>
			</li>
		</ul>

		<!-- Botón de cerrar sesión -->
		<div class="logout-container">
			<form id="logoutForm" th:action="@{/logout}" method="post">
				<button type="button" class="btn btn-danger" onclick="confirmLogout()">
					<i class="fas fa-sign-out-alt"></i>
					<span>Cerrar Sesión</span>
				</button>
			</form>
		</div>
	</nav>

	<div class="main-content">
		<!-- Search bar -->
		<div class="search-container">
			<div class="search-wrapper">
				<i class="fas fa-search search-icon"></i>
				<label for="searchInput"></label>
				<input type="text" class="search-input" id="searchInput" placeholder="Buscar por nombre..." oninput="filtrarTabla()">
			</div>
		</div>

		<!-- Stats -->
		<div class="stats-container">
			<div class="stats-position">
				<div class="position-div">
					<strong class="caja">Dinero en caja: </strong>$
					<span class="caja-span" th:text="${#numbers.formatDecimal(caja.cantidadActual, 0, 'POINT', 0, 'POINT')}"></span>
				</div>
				<div class="position-div">
					<strong class="cajaD">Suma Total:</strong>
					<span class="caja-span" id="sumaTotal">0.00</span>
				</div>
				<div class="position-div">
					<strong class="cajaD">Suma Ganancias:</strong>
					<span class="caja-span" id="sumaGanancias">0.00</span>
				</div>
				<div class="position-div">
					<strong class="cajaD">Total:</strong>
					<span class="caja-span" id="sumaTotalGanancias">0.00</span>
				</div>
				<div class="position-div">
					<strong class="cajaD">Seguro:</strong>
					<span class="caja-span" id="totalSeguros">0.00</span>
				</div>
			</div>
		</div>

		<!-- Loan grid -->
		<div class="loan-grid">
			<div th:each="prestamo : ${prestamos}"
				 class="loan-card"
				 th:id="'prestamo-' + ${prestamo.id}"
				 th:data-prestamo-id="${prestamo.id}"
				 th:onclick="|showModal('modal-${prestamo.id}')|">
				<div class="loan-header">
					<span th:text="'#' + ${prestamo.id}"></span>
					<span class="loan-status">Calculando...</span>
				</div>

				<div>
					<h3 th:text="${prestamo.nombre}" style="margin: 0.5rem 0; font-size: 1.125rem;"></h3>
					<!-- Usando th:switch para manejar los diferentes tipos de pago -->
					<div class="payment-info" th:switch="${prestamo.tipoPago}">
						<!-- Caso Diario -->
						<div th:case="'diario'" class="payment-amount">
                    <span th:if="${!prestamo.valorModificadoManualmente}">
                        $[[${#numbers.formatInteger(prestamo.pagoDiario, 0, 'COMMA')}]] /día
                    </span>
							<span th:if="${prestamo.valorModificadoManualmente}">
                        $[[${#numbers.formatInteger(prestamo.valorPagoModificado, 0, 'COMMA')}]] /día (modificado)
                    </span>
						</div>

						<!-- Caso Semanal -->
						<div th:case="'semanal'" class="payment-amount">
                    <span th:if="${!prestamo.valorModificadoManualmente}">
                        $[[${prestamo.pago_semanal}]] /semanal
                    </span>
							<span th:if="${prestamo.valorModificadoManualmente}">
                        $[[${prestamo.valorPagoModificado}]] /semanal (modificado)
                    </span>
						</div>

						<!-- Caso Quincenal -->
						<div th:case="'quincenal'" class="payment-amount">
                    <span th:if="${!prestamo.valorModificadoManualmente}">
                        $[[${prestamo.pago_quincenal}]] /quincenal
                    </span>
							<span th:if="${prestamo.valorModificadoManualmente}">
                        $[[${prestamo.valorPagoModificado}]] /quincenal (modificado)
                    </span>
						</div>

						<!-- Caso Mensual -->
						<div th:case="'mensual'" class="payment-amount">
                    <span th:if="${!prestamo.valorModificadoManualmente}">
                        $[[${prestamo.pago_mensual}]] /mensual
                    </span>
							<span th:if="${prestamo.valorModificadoManualmente}">
                        $[[${prestamo.valorPagoModificado}]] /mensual (modificado)
                    </span>
						</div>
					</div>
				</div>
			</div>
		</div>


		<!-- MODAL PARA AGREGAR ABONO -->
		<div th:each="prestamo : ${prestamos}" th:id="'modal-abono-' + ${prestamo.id}" class="modal">
			<div class="modal-content modal-position">
				<span class="modal-close" th:onclick="|hideModal('modal-abono-${prestamo.id}')|">&times;</span>

				<div class="modal-section">
					<h3>Realizar Abono</h3>
					<form th:action="@{'/abonar/' + ${prestamo.id}}"
						  method="post"
						  th:id="'form-abono-' + ${prestamo.id}"
						  onsubmit="return validateAbono(this);">
						<div class="form-group">
							<label th:for="'input-abono-' + ${prestamo.id}">Monto del Abono:</label>
							<input type="text"
								   th:id="'input-abono-' + ${prestamo.id}"
								   name="abono"
								   class="form-control"
								   required
								   placeholder="Ingrese el monto del abono"
								   oninput="formatMontoa(this)"
								   pattern="[0-9,.]+"
								   title="Solo se permiten números y separadores de miles/decimales" />
							<small class="text-muted">
								Total pendiente: <span th:text="${#numbers.formatCurrency(prestamo.total)}"></span>
							</small>
						</div>
						<div class="modal-footer">
							<button type="submit" class="btn btn-primary">Procesar Abono</button>
							<button type="button" class="btn btn-secondary"
									th:onclick="|hideModal('modal-abono-${prestamo.id}')|">Cancelar</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<!-- modal agregar dinero -->
		<div id="addMoneyModal" class="modal fade" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Agregar Dinero a la Caja</h5>
						<span class="modal-close" data-bs-dismiss="modal" aria-label="Close" aria-hidden="true">&times;</span>
					</div>
					<div class="modal-body">
						<form id="addMoneyForm" action="#" th:action="@{/caja/agregarDinero}" method="post" onsubmit="return validateMonto();">
							<div class="form-group">
								<label for="monto">Monto a agregar:</label>
								<input type="text" id="monto" name="monto" class="form-control" required placeholder="Ingrese el monto" oninput="formatMonto(this)" />
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="submit" class="btn btn-primary" form="addMoneyForm">Agregar</button>
						<a th:href="@{/caja/editar}" class="btn btn-info">Editar</a>
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Modal template -->
		<div th:each="prestamo : ${prestamos}" th:id="'modal-' + ${prestamo.id}" class="modal">
			<div class="modal-content">
				<span class="modal-close" th:onclick="|hideModal('modal-${prestamo.id}')|">&times;</span>

				<div class="modal-section">
					<h3>Información del Cliente</h3>
					<p class="info-line parrafo1">
						<i class="fas fa-user"></i> <span th:text="${prestamo.nombre}"></span>
						<i class="fas fa-phone ms-3"></i> <span th:text="${#strings.replace(prestamo.telefono, 'E9', '')}"></span>
					</p>
					<p class="info-line parrafo2">
						<i class="fas fa-map-marker-alt"></i> <span th:text="${prestamo.direccion}"></span>
					</p>
				</div>

				<div class="modal-section">
					<h3>Detalles del Préstamo</h3>
					<p class="seccion-parrafo">
						Monto $ <span th:text="${#numbers.formatInteger(prestamo.montoPrestamo, 0, 'POINT')}"></span><br>
						Interés: <span th:text="${#numbers.formatDecimal(prestamo.tasaInteres, 0, 'POINT', 1, 'COMMA')}"></span>%<br>

						<th:block th:switch="${prestamo.tipoPago}">
						<span th:case="'diario'">
							  Pago Diario $ <span th:text="${prestamo.valorModificadoManualmente ?
								 #numbers.formatInteger(prestamo.valorPagoModificado, 0, 'POINT') :
								 #numbers.formatInteger(prestamo.pagoDiario, 0, 'POINT')}"></span>
							</span>
							<span th:case="'semanal'">
							Pago Semanal <span th:text="${prestamo.valorModificadoManualmente ?
								#numbers.formatInteger(prestamo.valorPagoModificado, 0, 'POINT') :
								prestamo.pago_semanal}"></span>
						</span>
							<span th:case="'quincenal'">
							Pago Quincenal  <span th:text="${prestamo.valorModificadoManualmente ?
								#numbers.formatInteger(prestamo.valorPagoModificado, 0, 'POINT') :
								prestamo.pago_quincenal}"></span>
						</span>
							<span th:case="'mensual'">
							Pago Mensual  <span th:text="${prestamo.valorModificadoManualmente ?
								#numbers.formatInteger(prestamo.valorPagoModificado, 0, 'POINT') :
								prestamo.pago_mensual}"></span>
						</span>
						</th:block>
						<br>

						Seguro: <span th:text="${#numbers.formatInteger(prestamo.seguro, 0, 'POINT')}"></span><br>
						Total: <span th:text="${#numbers.formatInteger(prestamo.total, 0, 'POINT')}"></span><br>
						Ganancias: <span th:text="${#numbers.formatInteger(prestamo.gananciasPrestamista, 0, 'POINT')}"></span>
					</p>
				</div>

				<div class="modal-section">
					<h3>Fechas</h3>
					<p class="seccion-parrafo">
						Préstamo: <span th:text="${prestamo.formattedFechaPrestamo}"></span><br>
						Pago: <span th:text="${prestamo.formattedFechaPago}"></span>
					</p>
				</div>

				<div class="modal-actions">
					<a sec:authorize="hasAnyRole('ADMIN')"
					   th:href="@{'/form/' + ${prestamo.id}}"
					   class="action-button btn-edit">
						<i class="fas fa-edit"></i> Editar
					</a>
					<a sec:authorize="hasRole('ADMIN')"
					   th:onclick="|confirmarEliminacion(event, '/eliminar/' + ${prestamo.id})|"
					   class="action-button btn-delete">
						<i class="fas fa-trash"></i> Eliminar
					</a>
					<a sec:authorize="hasAnyRole('ADMIN', 'COBRADOR1' , 'COBRADOR2')"
					   th:onclick="|showModalAbono(${prestamo.id})|"
					   class="action-button btn-primary"
					   style="cursor: pointer;">
						<i class="fas fa-money-bill"></i> Abonar
					</a>
				</div>
			</div>
		</div>
	</div>

	<footer class="footer">
		<div class="paginator">
			<nav class="pagination" th:replace="paginator-nav :: paginator"></nav>
		</div>

		<small class="text-muted">
			<p>&copy; 2024 Software Préstamos. Todos los derechos reservados.</p>
		</small>
	</footer>

</div>

<script>

	function validarEstadoPrestamo(prestamoId) {
		fetch(`/prestamos/estado?prestamoId=${prestamoId}`)
				.then(response => {
					if (!response.ok) {
						throw new Error('Error al obtener el estado del préstamo');
					}
					return response.json();
				})
				.then(data => {
					const estadoElement = document.querySelector(`#prestamo-${prestamoId} .loan-status`);
					if (!estadoElement) return;

					// Actualizar el estado visual
					estadoElement.textContent = data.estado;
					estadoElement.classList.remove('status-ontime', 'status-late', 'status-warning');

					if (data.estado === "PAGADO") {
						estadoElement.classList.add('status-ontime');
					} else if (data.estado === "ATRASADO") {
						estadoElement.classList.add('status-late');
						estadoElement.textContent += ` (${data.diasAtraso} días)`;
					} else {
						estadoElement.classList.add('status-ontime_active'); // ACTIVO
					}
				})
				.catch(error => {
					console.error('Error al verificar estado:', error);
					Swal.fire({
						icon: 'error',
						title: 'Error',
						text: 'No se pudo obtener el estado del préstamo',
						timer: 3000,
						timerProgressBar: true
					});
				});
	}

	function determinarEstado(tipoPago, porcentajePagado, diasRetraso, totalPendiente) {
		// Si está completamente pagado
		if (totalPendiente <= 0) {
			return {
				estado: 'Pagado',
				clase: 'status-ontime',
				mensaje: ''
			};
		}

		// Si tiene retraso
		if (diasRetraso > 0) {
			const umbralesTolerancia = {
				'diario': 1,
				'semanal': 3,
				'quincenal': 5,
				'mensual': 7
			};

			// Obtener umbral según tipo de pago
			let umbralDias = 1; // Por defecto diario
			for (const [tipo, umbral] of Object.entries(umbralesTolerancia)) {
				if (tipoPago.includes(tipo)) {
					umbralDias = umbral;
					break;
				}
			}

			// Si el retraso supera el umbral
			if (diasRetraso > umbralDias) {
				return {
					estado: 'Retrasado',
					clase: 'status-late',
					mensaje: ` (${diasRetraso} días)`
				};
			}
		}

		// Si no tiene retraso, evaluar por porcentaje según tipo de pago
		const umbrales = {
			'diario': { alDia: 70, pendiente: 40 },
			'semanal': { alDia: 50, pendiente: 25 },
			'quincenal': { alDia: 40, pendiente: 20 },
			'mensual': { alDia: 30, pendiente: 15 }
		};

		let umbralActual = umbrales.diario; // Por defecto
		for (const [tipo, umbral] of Object.entries(umbrales)) {
			if (tipoPago.includes(tipo)) {
				umbralActual = umbral;
				break;
			}
		}

		if (porcentajePagado >= umbralActual.alDia) {
			return {
				estado: 'Al día',
				clase: 'status-ontime',
				mensaje: ''
			};
		} else if (porcentajePagado >= umbralActual.pendiente) {
			return {
				estado: 'Pendiente',
				clase: 'status-warning',
				mensaje: ` (${porcentajePagado.toFixed(1)}%)`
			};
		}

		return {
			estado: 'Atrasado',
			clase: 'status-late',
			mensaje: ` (${porcentajePagado.toFixed(1)}%)`
		};
	}

	function actualizarEstadoVisual(elemento, estado, clase, mensaje) {
		elemento.textContent = estado + mensaje;
		elemento.classList.remove('status-ontime', 'status-late', 'status-warning');
		elemento.classList.add(clase);
	}

	// Llamar a la función para cada préstamo al cargar la página
	document.addEventListener('DOMContentLoaded', () => {
		const prestamos = document.querySelectorAll('.loan-card');
		prestamos.forEach(prestamo => {
			const prestamoId = prestamo.dataset.prestamoId;
			validarEstadoPrestamo(prestamoId);
		});
	});

	function validateAbono(form) {
		const abonoInput = form.querySelector('input[name="abono"]');
		const monto = abonoInput.value.replace(/\./g, '').replace(/,/g, '.');

		if (parseFloat(monto) <= 0 || isNaN(parseFloat(monto))) {
			Swal.fire({
				icon: 'error',
				title: 'Error',
				text: 'El monto del abono debe ser mayor que cero',
				timer: 3000,
				timerProgressBar: true
			});
			return false;
		}

		Swal.fire({
			title: '¿Confirmar abono?',
			text: `¿Deseas procesar un abono de $${parseFloat(monto).toLocaleString('es-CO')}?`,
			icon: 'question',
			showCancelButton: true,
			confirmButtonColor: '#3085d6',
			cancelButtonColor: '#d33',
			confirmButtonText: 'Sí, procesar',
			cancelButtonText: 'Cancelar'
		}).then((result) => {
			if (result.isConfirmed) {
				abonoInput.value = monto;
				form.submit();
			}
		});

		return false; // Evitar envío inmediato del formulario
	}

	// Llamar a la función para cada input de monto
	document.querySelectorAll('input[name="abono"]').forEach(input => {
		formatMontoa(input);
	});


	document.addEventListener('DOMContentLoaded', () => {
		// Selecciona todos los formularios de abono
		const abonoForms = document.querySelectorAll('form[id^="form-abono-"]');

		abonoForms.forEach(form => {
			const abonoInput = form.querySelector('input[name="abono"]');
			const estadoElement = form.closest('.modal').querySelector('.loan-status');

			if (abonoInput && estadoElement) {
				abonoInput.addEventListener('input', function() {
					const abono = parseFloat(this.value.replace(/\./g, '').replace(/,/g, '.')) || 0;
					const totalPendienteText = form.querySelector('.text-muted span').textContent
							.replace('$', '')
							.replace(/\./g, '')
							.replace(/,/g, '');
					const totalPendiente = parseFloat(totalPendienteText);

					// Lógica simplificada de estado
					if (abono >= totalPendiente) {
						estadoElement.textContent = 'Al día';
						estadoElement.classList.remove('status-late');
						estadoElement.classList.add('status-ontime');
					} else {
						estadoElement.textContent = 'Retrasado';
						estadoElement.classList.remove('status-ontime');
						estadoElement.classList.add('status-late');
					}
				});
			}
		});
	});


	// Funciones para manejo de modales y abonos
	function showModalAbono(prestamoId) {
		// Primero cerramos el modal template
		hideModal('modal-' + prestamoId);

		// Luego abrimos el modal de abono
		const modalId = 'modal-abono-' + prestamoId;
		const modal = document.getElementById(modalId);
		if (modal) {
			modal.style.display = 'block';
			document.body.style.overflow = 'hidden';
		}
	}


	function formatMontoa(input) {
		input.addEventListener('input', function() {
			// Solo permitir números y coma decimal
			let value = this.value.replace(/[^\d,]/g, '');

			// Asegurar un solo separador decimal
			const parts = value.split(',');
			if (parts.length > 2) {
				value = parts[0] + ',' + parts.slice(1).join('');
			}

			// Formatear parte entera con separadores de miles
			const [integer, decimal] = value.split(',');
			const formattedInteger = integer.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

			// Combinar partes
			this.value = decimal ? `${formattedInteger},${decimal}` : formattedInteger;
		});
	}


	function formatMonto(input) {
		// Remover caracteres que no sean dígitos
		let value = input.value.replace(/\D/g, '');

		// Formatear con separadores de miles usando punto
		if (value) {
			input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
		} else {
			input.value = '';
		}
	}

	function validateMonto() {
		const montoInput = document.getElementById('monto');
		// Reemplazar puntos de miles y coma decimal
		let monto = montoInput.value.replace(/\./g, '').replace(/,/g, '.');

		// Convertir a número
		let numero = parseFloat(monto);

		// Validar monto positivo
		if (numero <= 0) {
			Swal.fire({
				icon: 'error',
				title: 'Error',
				text: 'El monto debe ser mayor que cero',
				timer: 3000,
				timerProgressBar: true
			});
			return false;
		}

		// Formatear input con separadores de miles
		montoInput.value = numero.toLocaleString('es-CO', {
			minimumFractionDigits: 0,
			maximumFractionDigits: 0,
			useGrouping: true
		});

		return true;
	}


	// Funciones de manejo del modal
	function showModal(modalId) {
		console.log('Attempting to show modal:', modalId);

		const modal = document.getElementById(modalId);

		if (modal) {
			console.log('Modal found:', modal);
			modal.style.display = 'block';
			document.body.style.overflow = 'hidden';
		} else {
			console.error(`Modal with id ${modalId} not found`);
			// Opcional: mostrar todos los modales existentes para depuración
			const allModals = document.querySelectorAll('.modal');
			console.log('Existing modals:', allModals);
		}
	}

	function hideModal(modalId) {
		const modal = document.getElementById(modalId);
		if (modal) {
			modal.style.display = 'none';
			// Solo restauramos el scroll si no hay otros modales visibles
			const visibleModals = document.querySelectorAll('.modal[style="display: block"]');
			if (visibleModals.length === 0) {
				document.body.style.overflow = 'auto';
			}
		}
	}

	// Manejador de clics fuera del modal
	window.onclick = function(event) {
		if (event.target.classList.contains('modal')) {
			hideModal(event.target.id);
		}
	}

	// Agregar listener para los mensajes flash
	document.addEventListener('DOMContentLoaded', function() {
		// Verificar si hay mensaje flash de éxito
		const successMessage = document.querySelector('[data-flash-success]');
		if (successMessage) {
			Swal.fire({
				icon: 'success',
				title: 'Éxito',
				text: successMessage.getAttribute('data-flash-message'),
				timer: 3000,
				timerProgressBar: true
			});
		}

		// Verificar si hay mensaje flash de error
		const errorMessage = document.querySelector('[data-flash-error]');
		if (errorMessage) {
			Swal.fire({
				icon: 'error',
				title: 'Error',
				text: errorMessage.getAttribute('data-flash-message'),
				timer: 3000,
				timerProgressBar: true
			});
		}
	});



	// Inicialización del sidebar y toggle
	document.addEventListener('DOMContentLoaded', function() {
		const sidebar = document.getElementById('sidebar');

		if (!sidebar) return; // Salir si no existe el sidebar

		// Crear el botón de toggle solo si no existe
		let sidebarToggle = document.querySelector('.sidebar-toggle');
		if (!sidebarToggle) {
			sidebarToggle = document.createElement('button');
			sidebarToggle.classList.add('sidebar-toggle');
			sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
			sidebar.parentNode.insertBefore(sidebarToggle, sidebar.nextSibling);
		}

		// Función de toggle
		sidebarToggle.addEventListener('click', function() {
			if (sidebar) {
				sidebar.classList.toggle('active');
				const icon = this.querySelector('i');
				if (icon) {
					if (sidebar.classList.contains('active')) {
						icon.classList.remove('fa-bars');
						icon.classList.add('fa-times');
					} else {
						icon.classList.remove('fa-times');
						icon.classList.add('fa-bars');
					}
				}
			}
		});
	});

	// Función para sumar los totales y las ganancias
	function sumarTotalesYGanancias() {
		let totalSuma = 0;
		let gananciasSuma = 0;
		let totalSeguros = 0;

		// Obtener todos los párrafos con la clase seccion-parrafo
		const parrafos = document.querySelectorAll('.seccion-parrafo');

		parrafos.forEach(parrafo => {
			const texto = parrafo.textContent;

			// Buscar la línea que contiene "Total:" y extraer el valor
			if (texto.includes('Total:')) {
				const match = texto.match(/Total:\s*([0-9.]+)/);
				if (match) {
					// Eliminar puntos y convertir a número
					totalSuma += parseFloat(match[1].replace(/\./g, ''));
				}
			}

			// Buscar la línea que contiene "Ganancias:" y extraer el valor
			if (texto.includes('Ganancias:')) {
				const match = texto.match(/Ganancias:\s*([0-9.]+)/);
				if (match) {
					// Eliminar puntos y convertir a número
					gananciasSuma += parseFloat(match[1].replace(/\./g, ''));
				}
			}

			// Buscar la línea que contiene "Seguro:" y extraer el valor
			if (texto.includes('Seguro:')) {
				const match = texto.match(/Seguro:\s*([0-9.]+)/);
				if (match) {
					// Eliminar puntos y convertir a número
					totalSeguros += parseFloat(match[1].replace(/\./g, ''));
				}
			}
		});

		// Calcular suma total de ganancias
		const sumaTotalGanancias = totalSuma + gananciasSuma;

		// Formatear los números para mostrar con separadores de miles
		document.getElementById('sumaTotal').textContent = new Intl.NumberFormat('es-CO', {
			style: 'currency',
			currency: 'COP',
			minimumFractionDigits: 0,
			maximumFractionDigits: 0
		}).format(Math.round(totalSuma));

		document.getElementById('sumaGanancias').textContent = new Intl.NumberFormat('es-CO', {
			style: 'currency',
			currency: 'COP',
			minimumFractionDigits: 0,
			maximumFractionDigits: 0
		}).format(Math.round(gananciasSuma));

		document.getElementById('sumaTotalGanancias').textContent = new Intl.NumberFormat('es-CO', {
			style: 'currency',
			currency: 'COP',
			minimumFractionDigits: 0,
			maximumFractionDigits: 0
		}).format(Math.round(sumaTotalGanancias));

		document.getElementById('totalSeguros').textContent = new Intl.NumberFormat('es-CO', {
			style: 'currency',
			currency: 'COP',
			minimumFractionDigits: 0,
			maximumFractionDigits: 0
		}).format(Math.round(totalSeguros));
	}

	// Llamar a la función cuando se carga la página
	document.addEventListener('DOMContentLoaded', sumarTotalesYGanancias);


	// Función para filtrar la tabla
	function filtrarTabla() {
		const input = document.getElementById("searchInput");
		if (!input) {
			console.warn('Input de búsqueda no encontrado');
			return;
		}

		const filter = input.value.toLowerCase();
		const loanCards = document.querySelectorAll('.loan-card');

		loanCards.forEach(card => {
			const nombre = card.querySelector('h3').textContent.toLowerCase();
			if (nombre.includes(filter)) {
				card.style.display = "";
			} else {
				card.style.display = "none";
			}
		});
	}

	// Inicialización al cargar la página
	document.addEventListener('DOMContentLoaded', function() {
		// Inicializar búsqueda
		const searchInput = document.getElementById('searchInput');
		if (searchInput) {
			searchInput.addEventListener('input', filtrarTabla);
		}

		// Inicializar sumas
		sumarTotalesYGanancias();
	});

	// Función para confirmar cierre de sesión
	function confirmLogout() {
		const form = document.getElementById('logoutForm');
		if (!form) {
			console.warn('Formulario de logout no encontrado');
			return;
		}

		Swal.fire({
			title: '¿Estás seguro?',
			text: "¿Deseas cerrar la sesión?",
			icon: 'warning',
			showCancelButton: true,
			confirmButtonColor: '#3085d6',
			cancelButtonColor: '#d33',
			confirmButtonText: 'Sí, cerrar sesión',
			cancelButtonText: 'Cancelar'
		}).then((result) => {
			if (result.isConfirmed && form) {
				form.submit();
			}
		});
	}

	function confirmarEliminacion(event, url) {
		event.preventDefault(); // Evita que el enlace se siga de inmediato
		Swal.fire({
			title: '¿Estás seguro?',
			text: "Esta acción no se puede deshacer.",
			icon: 'warning',
			showCancelButton: true,
			confirmButtonColor: '#3085d6',
			cancelButtonColor: '#d33',
			confirmButtonText: 'Sí, eliminar',
			cancelButtonText: 'Cancelar'
		}).then((result) => {
			if (result.isConfirmed) {
				window.location.href = url; // Redirige a la URL de eliminación si el usuario confirma
			}
		});
	}

	function exportarPrestamosAPDF() {
		// Importar jsPDF y jsPDF-AutoTable
		const { jsPDF } = window.jspdf;

		// Crear un nuevo documento PDF en orientación horizontal
		const doc = new jsPDF('landscape');

		// Estilos de fuente
		const estiloTitulo = {
			fontSize: 16,
			fontStyle: 'bold',
			textColor: [0, 0, 0]
		};

		const estiloSubtitulo = {
			fontSize: 12,
			fontStyle: 'normal',
			textColor: [16, 16, 16]
		};

		// Título del documento
		doc.setFont('helvetica', 'bold');
		doc.setFontSize(estiloTitulo.fontSize);
		doc.text('Lista de Préstamos', doc.internal.pageSize.width / 2, 20, { align: 'center' });

		// Fecha de generación
		doc.setFont('helvetica', 'normal');
		doc.setFontSize(estiloSubtitulo.fontSize);
		const fechaActual = new Date().toLocaleString();
		doc.text(`Fecha de generación: ${fechaActual}`, doc.internal.pageSize.width - 20, 30, { align: 'right' });

		// Preparar datos de los préstamos
		const prestamos = [];
		const loanCards = document.querySelectorAll('.loan-card');

		loanCards.forEach(card => {
			try {
				// Obtener el ID del préstamo
				const idElement = card.querySelector('.loan-header span:first-child');
				const nombreElement = card.querySelector('h3');
				const statusElement = card.querySelector('.loan-status');

				if (!idElement || !nombreElement || !statusElement) {
					console.warn('Elemento no encontrado en la tarjeta:', card);
					return;
				}

				// Obtener el modal relacionado
				const cardId = card.getAttribute('data-prestamo-id');
				const modal = document.getElementById(`modal-${cardId}`);

				if (!modal) {
					console.warn('Modal no encontrado para:', cardId);
					return;
				}

				// Extraer información del modal
				const parrafos = modal.querySelectorAll('.seccion-parrafo');

				const datosPrestamo = {
					id: idElement.textContent.trim().replace('#', ''),
					nombre: nombreElement.textContent.trim(),
					estado: statusElement.textContent.trim(),
					direccion: modal.querySelector('.parrafo2 span')?.textContent.trim() || 'N/A',
					telefono: modal.querySelector('.parrafo1 span:nth-child(4)')?.textContent.trim() || 'N/A',
					montoPrestamo: '',
					tasaInteres: '',
					seguro: '',
					fechaPrestamo: '',
					fechaPago: '',
					total: '',
					ganancias: ''
				};

				// Extraer información de los párrafos del modal
				parrafos.forEach(parrafo => {
					const texto = parrafo.textContent.trim();

					if (texto.includes('Monto $')) {
						datosPrestamo.montoPrestamo = texto.split('Monto $')[1].split('\n')[0].trim();
					}
					if (texto.includes('Interés:')) {
						datosPrestamo.tasaInteres = texto.split('Interés:')[1].split('\n')[0].trim();
					}
					if (texto.includes('Seguro:')) {
						datosPrestamo.seguro = texto.split('Seguro:')[1].split('\n')[0].trim();
					}
					if (texto.includes('Total:')) {
						datosPrestamo.total = texto.split('Total:')[1].split('\n')[0].trim();
					}
					if (texto.includes('Ganancias:')) {
						datosPrestamo.ganancias = texto.split('Ganancias:')[1].split('\n')[0].trim();
					}
					// Extraer fechas
					if (texto.includes('Préstamo:') && texto.includes('Pago:')) {
						const lineas = texto.split('\n');
						lineas.forEach(linea => {
							if (linea.includes('Préstamo:')) {
								datosPrestamo.fechaPrestamo = linea.split('Préstamo:')[1].trim();
							}
							if (linea.includes('Pago:')) {
								datosPrestamo.fechaPago = linea.split('Pago:')[1].trim();
							}
						});
					}
				});

				prestamos.push(Object.values(datosPrestamo));
			} catch (error) {
				console.error('Error procesando préstamo:', error);
			}
		});

		// Verificar si hay préstamos para exportar
		if (prestamos.length === 0) {
			Swal.fire({
				icon: 'warning',
				title: 'Sin Datos',
				text: 'No se encontraron préstamos para exportar',
				timer: 3000,
				timerProgressBar: true
			});
			return;
		}

		// Columnas para la tabla
		const columns = [
			'ID', 'Nombre', 'Estado', 'Dirección', 'Teléfono',
			'Monto Préstamo', 'Tasa Interés', 'Seguro', 'Fecha Préstamo',
			'Fecha Pago', 'Total', 'Ganancias'
		];

		// Generar tabla con autoTable
		doc.autoTable({
			startY: 40,
			head: [columns],
			body: prestamos,
			theme: 'striped',
			headStyles: {
				fillColor: [211, 211, 211],
				textColor: [0, 0, 0],
				fontStyle: 'bold'
			},
			styles: {
				fontSize: 8,
				cellPadding: 3
			},
			columnStyles: {
				0: { cellWidth: 15 },
				1: { cellWidth: 'auto' },
				2: { cellWidth: 25 },
				3: { cellWidth: 25 }
			}
		});

		// Pie de página
		const pageCount = doc.internal.getNumberOfPages();
		for (let i = 1; i <= pageCount; i++) {
			doc.setPage(i);
			doc.setFontSize(10);
			doc.text('Documento generado automáticamente',
					doc.internal.pageSize.width / 2,
					doc.internal.pageSize.height - 10,
					{ align: 'center' }
			);
		}

		// Generar nombre de archivo
		const fechaArchivo = new Date().toISOString().split('T')[0];
		const nombreArchivo = `Prestamos_${fechaArchivo}.pdf`;

		// Guardar PDF
		doc.save(nombreArchivo);

		// Mostrar mensaje de éxito
		Swal.fire({
			icon: 'success',
			title: 'PDF Generado',
			text: `Se han exportado ${prestamos.length} préstamos`,
			timer: 2000,
			timerProgressBar: true
		});
	}

	// Agregar botón de exportación
	document.addEventListener('DOMContentLoaded', () => {
		const exportarPDFBtn = document.getElementById('exportarPDFBtn');

		if (exportarPDFBtn) {
			exportarPDFBtn.addEventListener('click', function(event) {
				event.preventDefault(); // Prevenir la navegación predeterminada
				exportarPrestamosAPDF(); // Llamar a tu función de exportación
			});
		}
	});


</script>

</body>
</html>